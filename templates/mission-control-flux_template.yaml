---
# Source: mission-control-flux/templates/flux.yaml
apiVersion: canaries.flanksource.com/v1
kind: Topology
metadata:
  name: flux
spec:
  icon: flux
  type: Topology
  schedule: "@every 5m"
  components:
    - name: Controllers
      icon: pod
      selectors:
        - types:
            - Kubernetes::Pod
          labelSelector: 'namespace=flux-system'
    - name: Releases
      icon: helm
      components:
      - name: HelmReleases Component
        type: lookup
        lookup:
          catalog:
            - selector:
                - types: ['Kubernetes::HelmRelease']
              display:
                expr: |
                  dyn(results).map(r, {
                    'name': r.name,
                    'icon': 'helm',
                    'namespace': r.config.metadata.namespace,
                    'status': r.status,
                    'status_reason': r.description,
                    'selectors': [{'labelSelector': 'app.kubernetes.io/instance='+r.name}],
                    'configs': [{'name': r.name, 'namespace': r.config.metadata.namespace, 'type': 'Kubernetes::HelmRelease'}],
                    'properties': [
                      {'name': 'Message', 'text': r.config.status.conditions[0].message},
                      {'name': 'Version', 'text': has(r.config.status.lastAppliedRevision) ? r.config.status.lastAppliedRevision : '', 'headline': true},
                      {'name': 'Last attempted version', 'text': has(r.config.status.lastAttemptedRevision) ? r.config.status.lastAttemptedRevision : '', 'headline': true},
                    ],
                  }).toJSON()

    - name: Kustomizations
      icon: kustomize
      components:
      - name: Kustomizations Component
        type: lookup
        lookup:
          catalog:
            - selector:
                - types: ['Kubernetes::Kustomization']
              display:
                expr: |
                  dyn(results).map(r, {
                    'name': r.name,
                    'icon': 'kustomize',
                    'namespace': r.config.metadata.namespace,
                    'status': r.status,
                    'status_reason': r.description,
                    'selectors': [{'labelSelector': 'kustomize.toolkit.fluxcd.io/name='+r.name + ',kustomize.toolkit.fluxcd.io/namespace='+r.config.metadata.namespace}],
                    'configs': [{'name': r.name, 'namespace': r.config.metadata.namespace, 'type': 'Kubernetes::Kustomization'}],
                    'properties': [
                      {'name': 'Message', 'text': r.config.status.conditions[0].message},
                      {'name': 'State', 'text': r.config.status.conditions[0].type, 'headline': true},
                    ],
                  }).toJSON()

    - name: Repos
      icon: helm
      components:
      - name: HelmRepo Component
        type: lookup
        lookup:
          catalog:
            - selector:
                - types: ['Kubernetes::HelmRepository']
              display:
                expr: |
                  dyn(results).map(r, {
                    'name': r.name,
                    'icon': 'helm',
                    'namespace': r.config.metadata.namespace,
                    'status': r.status,
                    'status_reason': r.description,
                    'configs': [{'name': r.name, 'namespace': r.config.metadata.namespace, 'type': 'Kubernetes::HelmRepository'}],
                    'properties': [
                      {'name': 'Message', 'text': r.config.status.conditions[0].message},
                      {'name': 'State', 'text': r.config.status.conditions[0].type, 'headline': true},
                    ],
                  }).toJSON()

    - name: Git
      icon: git
      components:
      - name: GitRepo Component
        type: lookup
        lookup:
          catalog:
            - selector:
                - types: ['Kubernetes::GitRepository']
              display:
                expr: |
                  dyn(results).map(r, {
                    'name': r.name,
                    'icon': 'git',
                    'namespace': r.config.metadata.namespace,
                    'status': r.status,
                    'status_reason': r.description,
                    'configs': [{'name': r.name, 'namespace': r.config.metadata.namespace, 'type': 'Kubernetes::GitRepository'}],
                    'properties': [
                      {'name': 'Message', 'text': r.config.status.conditions[0].message},
                      {'name': 'State', 'text': r.config.status.conditions[0].type, 'headline': true},
                    ],
                  }).toJSON()
